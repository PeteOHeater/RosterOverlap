<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilot Roster Overlap Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-block;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .pilot-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pilot-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
        }

        .pilot-card:hover {
            transform: translateX(5px);
        }

        .pilot-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .pilot-details {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
        }

        .pilot-location {
            margin-top: 15px;
        }

        .pilot-location label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        .pilot-location input,
        .pilot-location select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95em;
        }

        .overlap-results {
            margin-top: 30px;
        }

        .overlap-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #28a745;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .overlap-card.warning {
            border-left-color: #ffc107;
        }

        .overlap-date {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .overlap-location {
            font-size: 1.1em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .overlap-pilots {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .pilot-schedule {
            background: white;
            padding: 12px 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            flex: 1;
            min-width: 200px;
        }

        .pilot-schedule-name {
            font-weight: 700;
            color: #764ba2;
            margin-bottom: 5px;
        }

        .pilot-schedule-time {
            color: #555;
            font-size: 0.95em;
        }

        .overlap-duration {
            background: #28a745;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 600;
            font-size: 0.9em;
        }

        .no-overlaps {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1em;
        }

        .stats-bar {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
            padding: 10px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .airport-codes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .airport-code {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }

            .pilot-list {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                flex-direction: column;
            }

            .overlap-pilots {
                flex-direction: column;
            }
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .info-box strong {
            color: #1976D2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è Pilot Roster Overlap Analyzer</h1>
            <p>Find when crew members are in the same location</p>
        </div>

        <div class="content">
            <!-- Upload Section -->
            <div class="section">
                <h2 class="section-title">üì§ Upload Rosters</h2>
                <div class="info-box">
                    <strong>Note:</strong> Upload Qantas ARMS roster files (.txt format). Each pilot should upload their own roster. 
                    Files are processed locally in your browser - no data is sent to any server.
                </div>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Drop roster files here or click to browse</h3>
                    <p>Supports up to 10 pilots</p>
                    <input type="file" id="fileInput" accept=".txt" multiple>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn" onclick="document.getElementById('fileInput').click()">
                        Browse Files
                    </button>
                    <button class="btn btn-secondary" onclick="clearAllData()">
                        Clear All Data
                    </button>
                </div>
            </div>

            <!-- Pilots Section -->
            <div class="section" id="pilotsSection" style="display: none;">
                <h2 class="section-title">üë®‚Äç‚úàÔ∏è Loaded Pilots</h2>
                <div id="pilotsList" class="pilot-list"></div>
            </div>

            <!-- Analysis Button -->
            <div class="section" id="analyzeSection" style="display: none; text-align: center;">
                <button class="btn" onclick="analyzeOverlaps()" style="font-size: 1.2em; padding: 15px 40px;">
                    üîç Find Overlaps
                </button>
            </div>

            <!-- Results Section -->
            <div class="section" id="resultsSection" style="display: none;">
                <h2 class="section-title">üéØ Overlap Opportunities</h2>
                <div class="stats-bar" id="statsBar"></div>
                <div id="overlapResults" class="overlap-results"></div>
            </div>
        </div>
    </div>

    <script>
        // Global storage for pilot data
        let pilotsData = [];
        const STORAGE_KEY = 'pilotRosterData';
        const LOCATIONS_KEY = 'pilotLocations';

        // Common airport codes for Australia
        const AIRPORT_NAMES = {
            'ADL': 'Adelaide',
            'SYD': 'Sydney',
            'MEL': 'Melbourne',
            'BNE': 'Brisbane',
            'PER': 'Perth',
            'OOL': 'Gold Coast',
            'CBR': 'Canberra',
            'DRW': 'Darwin',
            'HBA': 'Hobart',
            'CNS': 'Cairns',
            'AKL': 'Auckland',
            'WLG': 'Wellington',
            'HTI': 'Hamilton Island',
            'JFK': 'New York'
        };

        // Load saved data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSavedData();
            setupEventListeners();
        });

        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            if (files.length === 0) return;

            if (pilotsData.length + files.length > 10) {
                alert('Maximum 10 pilots supported. Please remove some rosters first.');
                return;
            }

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        parseRoster(e.target.result, file.name);
                    } catch (error) {
                        console.error('Error parsing roster:', error);
                        alert(`Error parsing ${file.name}: ${error.message}`);
                    }
                };
                reader.readAsText(file);
            });
        }

        function parseRoster(content, filename) {
            const pilot = {
                id: Date.now() + Math.random(),
                filename: filename,
                name: '',
                staffNo: '',
                category: '',
                base: '',
                rosterType: '',
                schedule: []
            };

            // Extract pilot information
            const nameMatch = content.match(/Name\s*:\s*([A-Z\s]+)/);
            if (nameMatch) pilot.name = nameMatch[1].trim();

            const staffMatch = content.match(/Staff No:\s*(\d+)/);
            if (staffMatch) pilot.staffNo = staffMatch[1];

            const categoryMatch = content.match(/Category:\s*(CPT-B\d+)/);
            if (categoryMatch) {
                pilot.category = categoryMatch[1];
                pilot.rosterType = categoryMatch[1].includes('787') ? 'Long Haul' : 'Short Haul';
            }

            const baseMatch = content.match(/Base\s*:\s*([A-Z]{3})/);
            if (baseMatch) pilot.base = baseMatch[1];

            // Parse schedule
            pilot.schedule = parseSchedule(content, pilot.rosterType);

            // Add to pilots data
            pilotsData.push(pilot);
            saveData();
            updateUI();
        }

        function parseSchedule(content, rosterType) {
            const schedule = [];
            const lines = content.split('\n');

            // For short haul - parse the duty roster
            const datePattern = /^(\d{2})\s+(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+(\S+)\s+(.*)\s+(\d{4})\s+(\d{4})/;
            const datePatternDO = /^(\d{2})\s+(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+(D\/O|AV|AL|PLN|R4)/;

            // For long haul - parse the pattern details
            const flightPattern = /^(\d{2}\/\d{2})\s+[A-Z]\s+(\S+)/;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // Short haul duty lines
                const dutyMatch = line.match(datePattern);
                if (dutyMatch) {
                    const [, day, dow, duty, details, startTime, endTime] = dutyMatch;

                    // Extract port codes from the line
                    const ports = extractPorts(line);

                    schedule.push({
                        date: day,
                        dayOfWeek: dow,
                        duty: duty,
                        startTime: startTime,
                        endTime: endTime,
                        ports: ports,
                        type: 'DUTY'
                    });
                }

                // Days off, available, leave
                const doMatch = line.match(datePatternDO);
                if (doMatch) {
                    const [, day, dow, type] = doMatch;
                    schedule.push({
                        date: day,
                        dayOfWeek: dow,
                        duty: type,
                        type: type === 'D/O' ? 'OFF' : type === 'AV' ? 'AVAILABLE' : type === 'AL' ? 'LEAVE' : 'OTHER'
                    });
                }

                // Long haul pattern dates
                const lhMatch = line.match(flightPattern);
                if (lhMatch) {
                    const [, date, type] = lhMatch;
                    schedule.push({
                        date: date,
                        duty: type,
                        type: type === 'AL' ? 'LEAVE' : type.includes('NN') || type.includes('TR') ? 'DUTY' : 'OTHER'
                    });
                }
            }

            // Parse detailed flight information
            const flightDetails = parseFlightDetails(content);
            schedule.forEach(day => {
                if (day.type === 'DUTY' && flightDetails[day.date]) {
                    day.flights = flightDetails[day.date];
                }
            });

            return schedule;
        }

        function extractPorts(line) {
            const ports = [];
            const portMatches = line.matchAll(/\b([A-Z]{3})\b/g);
            for (const match of portMatches) {
                const code = match[1];
                if (AIRPORT_NAMES[code] && !ports.includes(code)) {
                    ports.push(code);
                }
            }
            return ports;
        }

        function parseFlightDetails(content) {
            const flights = {};
            const lines = content.split('\n');

            // Look for flight detail sections
            const flightPattern = /(\d{2}[A-Z][a-z]{2})\s+(\d+)\s+([A-Z]{3})\s+(\d{4})\s+([A-Z]{3})\s+(\d{4})/;

            for (const line of lines) {
                const match = line.match(flightPattern);
                if (match) {
                    const [, date, flightNum, from, depTime, to, arrTime] = match;
                    const dateKey = date.substring(0, 2); // Extract day

                    if (!flights[dateKey]) flights[dateKey] = [];

                    flights[dateKey].push({
                        from: from,
                        to: to,
                        departure: depTime,
                        arrival: arrTime
                    });
                }
            }

            return flights;
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(pilotsData));
        }

        function loadSavedData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                pilotsData = JSON.parse(saved);
                updateUI();
            }
        }

        function updateUI() {
            const pilotsSection = document.getElementById('pilotsSection');
            const analyzeSection = document.getElementById('analyzeSection');
            const pilotsList = document.getElementById('pilotsList');

            if (pilotsData.length === 0) {
                pilotsSection.style.display = 'none';
                analyzeSection.style.display = 'none';
                return;
            }

            pilotsSection.style.display = 'block';
            analyzeSection.style.display = 'block';

            pilotsList.innerHTML = pilotsData.map(pilot => {
                const savedLocation = getSavedLocation(pilot.id);
                return `
                    <div class="pilot-card">
                        <div class="pilot-name">${pilot.name || 'Unknown'}</div>
                        <div class="pilot-details">
                            <div>Staff #: ${pilot.staffNo}</div>
                            <div>Type: ${pilot.rosterType}</div>
                            <div>Base: ${pilot.base}</div>
                            <div>Schedule: ${pilot.schedule.length} days</div>
                        </div>
                        <div class="pilot-location">
                            <label>Location on Days Off/Available/Leave:</label>
                            <select onchange="savePilotLocation('${pilot.id}', this.value)" id="location-${pilot.id}">
                                <option value="">Select location...</option>
                                ${Object.entries(AIRPORT_NAMES).map(([code, name]) => 
                                    `<option value="${code}" ${savedLocation === code ? 'selected' : ''}>${name} (${code})</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-danger" onclick="removePilot('${pilot.id}')" style="width: 100%;">
                                Remove Roster
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getSavedLocation(pilotId) {
            const locations = JSON.parse(localStorage.getItem(LOCATIONS_KEY) || '{}');
            return locations[pilotId] || '';
        }

        function savePilotLocation(pilotId, location) {
            const locations = JSON.parse(localStorage.getItem(LOCATIONS_KEY) || '{}');
            locations[pilotId] = location;
            localStorage.setItem(LOCATIONS_KEY, JSON.stringify(locations));
        }

        function removePilot(pilotId) {
            pilotsData = pilotsData.filter(p => p.id != pilotId);
            saveData();
            updateUI();
            document.getElementById('resultsSection').style.display = 'none';
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all pilot data and location settings?')) {
                pilotsData = [];
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(LOCATIONS_KEY);
                updateUI();
                document.getElementById('resultsSection').style.display = 'none';
            }
        }

        function analyzeOverlaps() {
            const overlaps = findOverlaps();
            displayOverlaps(overlaps);
        }

        function findOverlaps() {
            const overlaps = [];
            const locationMap = {};

            // Build location map for each day
            pilotsData.forEach(pilot => {
                const homeLocation = getSavedLocation(pilot.id);

                pilot.schedule.forEach(day => {
                    let location = null;
                    let startTime = null;
                    let endTime = null;
                    let status = '';

                    if (day.type === 'OFF' || day.type === 'AVAILABLE' || day.type === 'LEAVE') {
                        location = homeLocation;
                        startTime = '0000';
                        endTime = '2359';
                        status = day.type;
                    } else if (day.type === 'DUTY' && day.ports) {
                        // For duty days, check each port
                        day.ports.forEach(port => {
                            const key = `${day.date}-${port}`;
                            if (!locationMap[key]) locationMap[key] = [];

                            locationMap[key].push({
                                pilot: pilot,
                                day: day,
                                location: port,
                                startTime: day.startTime || '0000',
                                endTime: day.endTime || '2359',
                                status: 'DUTY'
                            });
                        });
                        return;
                    }

                    if (location) {
                        const key = `${day.date}-${location}`;
                        if (!locationMap[key]) locationMap[key] = [];

                        locationMap[key].push({
                            pilot: pilot,
                            day: day,
                            location: location,
                            startTime: startTime,
                            endTime: endTime,
                            status: status
                        });
                    }
                });
            });

            // Find overlaps (2+ pilots in same location on same day)
            Object.entries(locationMap).forEach(([key, pilots]) => {
                if (pilots.length < 2) return;

                // Check for time overlap
                for (let i = 0; i < pilots.length; i++) {
                    for (let j = i + 1; j < pilots.length; j++) {
                        const overlap = calculateOverlap(pilots[i], pilots[j]);
                        if (overlap && overlap.minutes >= 30) {
                            overlaps.push({
                                date: pilots[i].day.date,
                                location: pilots[i].location,
                                pilots: [pilots[i], pilots[j]],
                                overlapMinutes: overlap.minutes,
                                overlapStart: overlap.start,
                                overlapEnd: overlap.end
                            });
                        }
                    }
                }
            });

            // Sort by date
            overlaps.sort((a, b) => {
                const dateA = parseInt(a.date);
                const dateB = parseInt(b.date);
                return dateA - dateB;
            });

            return overlaps;
        }

        function calculateOverlap(pilot1, pilot2) {
            const start1 = parseInt(pilot1.startTime);
            const end1 = parseInt(pilot1.endTime);
            const start2 = parseInt(pilot2.startTime);
            const end2 = parseInt(pilot2.endTime);

            const overlapStart = Math.max(start1, start2);
            const overlapEnd = Math.min(end1, end2);

            if (overlapStart >= overlapEnd) return null;

            // Calculate minutes
            const startHours = Math.floor(overlapStart / 100);
            const startMins = overlapStart % 100;
            const endHours = Math.floor(overlapEnd / 100);
            const endMins = overlapEnd % 100;

            const totalMins = (endHours * 60 + endMins) - (startHours * 60 + startMins);

            return {
                minutes: totalMins,
                start: overlapStart,
                end: overlapEnd
            };
        }

        function displayOverlaps(overlaps) {
            const resultsSection = document.getElementById('resultsSection');
            const statsBar = document.getElementById('statsBar');
            const overlapResults = document.getElementById('overlapResults');

            resultsSection.style.display = 'block';

            // Display stats
            const uniqueDates = new Set(overlaps.map(o => o.date)).size;
            const uniqueLocations = new Set(overlaps.map(o => o.location)).size;

            statsBar.innerHTML = `
                <div class="stat">
                    <div class="stat-number">${overlaps.length}</div>
                    <div class="stat-label">Total Overlaps</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${uniqueDates}</div>
                    <div class="stat-label">Unique Days</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${uniqueLocations}</div>
                    <div class="stat-label">Locations</div>
                </div>
            `;

            if (overlaps.length === 0) {
                overlapResults.innerHTML = '<div class="no-overlaps">No overlaps found with at least 30 minutes. Try adjusting pilot locations for days off.</div>';
                return;
            }

            overlapResults.innerHTML = overlaps.map(overlap => {
                const hours = Math.floor(overlap.overlapMinutes / 60);
                const mins = overlap.overlapMinutes % 60;
                const durationText = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;

                return `
                    <div class="overlap-card">
                        <div class="overlap-date">üìÖ Day ${overlap.date}</div>
                        <div class="overlap-location">üìç ${AIRPORT_NAMES[overlap.location] || overlap.location}</div>
                        <div class="overlap-pilots">
                            ${overlap.pilots.map(p => `
                                <div class="pilot-schedule">
                                    <div class="pilot-schedule-name">${p.pilot.name}</div>
                                    <div class="pilot-schedule-time">
                                        ${formatTime(p.startTime)} - ${formatTime(p.endTime)}
                                        <br><small>${p.status}</small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div>
                            <span class="overlap-duration">‚è±Ô∏è ${durationText} overlap</span>
                            <small style="margin-left: 15px; color: #666;">
                                ${formatTime(overlap.overlapStart)} - ${formatTime(overlap.overlapEnd)}
                            </small>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function formatTime(time) {
            const timeStr = time.toString().padStart(4, '0');
            return `${timeStr.substring(0, 2)}:${timeStr.substring(2)}`;
        }
    </script>
</body>
</html>